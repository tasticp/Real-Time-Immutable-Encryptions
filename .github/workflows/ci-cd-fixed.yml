name: "Immutable Encryption CI/CD - Fixed Version"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 0" # Weekly security scan

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: full
  OPENCV_DISABLE_PROBES: 1
  LIBCLANG_PATH: /usr/lib/x86_64-linux-gnu
  PKG_CONFIG_PATH: /usr/lib/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig
  PKG_CONFIG_ALLOW_SYSTEM_CFLAGS: 1
  PKG_CONFIG_ALLOW_SYSTEM_LIBS: 1
  # Increased stack size for Rust
  RUST_MIN_STACK: 8388608

jobs:
  # Rust Backend Testing - Fixed
  rust-tests:
    name: Rust Backend Tests
    runs-on: ubuntu-22.04
    timeout-minutes: 90

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
          profile: minimal

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install system dependencies - Fixed
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            libssl-dev \
            libopencv-dev \
            libavformat-dev \
            libavfilter-dev \
            libavdevice-dev \
            libswscale-dev \
            libavcodec-dev \
            libavutil-dev \
            clang \
            libclang-dev \
            cmake \
            build-essential \
            git \
            libgtk-3-dev \
            libavcodec-dev \
            libavformat-dev \
            libswscale-dev \
            libv4l-dev \
            libxvidcore-dev \
            libx264-dev \
            libjpeg-dev \
            libpng-dev \
            libtiff-dev \
            libwebp-dev \
            libopenexr-dev \
            libgstreamer-plugins-base1.0-dev \
            gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad \
            gstreamer1.0-plugins-ugly \
            libdc1394-22-dev \
            libtheora-dev \
            libvorbis-dev \
            libxine2-dev \
            libvpx-dev \
            libmp3lame-dev \
            libfaac-dev \
            libopencore-amrnb-dev \
            libopencore-amrwb-dev

      - name: Verify OpenCV installation
        run: |
          pkg-config --modversion opencv4 || echo "OpenCV4 not found via pkg-config"
          ls /usr/include/opencv4/ || echo "OpenCV headers not found"

      - name: Configure Rust for OpenCV
        run: |
          echo "=== Configuring Rust Environment ==="
          echo "OPENCV_LIB_DIR=/usr/lib/x86_64-linux-gnu" >> $GITHUB_ENV
          echo "OPENCV_INCLUDE_DIR=/usr/include/opencv4" >> $GITHUB_ENV

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features --features video -- -D warnings

      - name: Run tests with increased stack
        run: |
          ulimit -s 8192
          cargo test --all --verbose --features video -- --test-threads=1

      - name: Build release
        run: cargo build --release --verbose --features video

      - name: Upload Rust binaries
        uses: actions/upload-artifact@v4
        with:
          name: rust-binaries
          path: |
            target/release/encryption-node
            target/release/verification-client
            target/release/blockchain-anchor
          retention-days: 7

  # Python API Testing - Fixed
  python-tests:
    name: Python API Tests
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    strategy:
      matrix:
        python-version: ["3.11"]  # Focus on most stable version
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install system dependencies for Python - Fixed
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            libgl1-mesa-glx \
            libglib2.0-0 \
            libsm6 \
            libxext6 \
            libxrender-dev \
            libgomp1 \
            libgtk-3-0 \
            libavcodec-dev \
            libavformat-dev \
            libswscale-dev \
            libv4l-dev \
            libxvidcore-dev \
            libx264-dev \
            libjpeg-dev \
            libpng-dev \
            libtiff-dev \
            python3-dev \
            python3-venv \
            ffmpeg \
            libsm6 \
            libxext6

      - name: Install Python dependencies - Fixed
        run: |
          python -m pip install --upgrade pip setuptools wheel
          # Install critical dependencies first
          pip install numpy==1.24.3 opencv-python-headless==4.8.1.78
          # Install remaining dependencies
          pip install -r requirements.txt

      - name: Verify OpenCV Python
        run: python -c "import cv2; print(f'OpenCV Python version: {cv2.__version__}')"

      - name: Install dev dependencies
        run: pip install pytest pytest-cov pytest-asyncio black flake8 mypy ruff

      - name: Run tests
        run: |
          cd python_api
          python -m pytest -v --tb=short --disable-warnings

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: success()
        with:
          file: python_api/coverage.xml
          flags: unittests
          name: python-coverage

  # Docker Build - Fixed
  docker-test:
    name: Docker Build Test
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    needs: [rust-tests, python-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Rust backend image - Fixed
        run: |
          docker build -f docker/rust-backend.Dockerfile -t immutable-encryption:test-rust .

      - name: Test Rust container
        run: |
          docker run --rm -d -p 8080:8080 --name test-rust immutable-encryption:test-rust
          sleep 20
          for i in {1..10}; do
            if curl -f http://localhost:8080/health; then
              echo "Rust health check passed"
              break
            fi
            sleep 10
            echo "Retry $i/10..."
          done
          docker logs test-rust || true
          docker stop test-rust || true

      - name: Build Python API image - Fixed
        run: |
          docker build -f docker/python-api.Dockerfile -t immutable-encryption:test-python .

      - name: Test Python container
        run: |
          docker run --rm -d -p 8000:8000 --name test-python immutable-encryption:test-python
          sleep 20
          for i in {1..10}; do
            if curl -f http://localhost:8000/health; then
              echo "Python health check passed"
              break
            fi
            sleep 10
            echo "Retry $i/10..."
          done
          docker logs test-python || true
          docker stop test-python || true

  # Security Scanning - Fixed
  security-scan:
    name: Security Scan
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"
          ignore-unfixed: true

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

      - name: Run Bandit security scan
        run: |
          pip install bandit
          bandit -r python_api/ -f json -o bandit-results.json || true

      - name: Upload Bandit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-results
          path: bandit-results.json
          retention-days: 7

  # Documentation - Fixed
  docs:
    name: Build Documentation
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install sphinx sphinx-rtd-theme

      - name: Build API documentation
        run: |
          echo "Building API documentation..."
          mkdir -p docs/_build/html
          cargo doc --no-deps --features video --no-deps
          cp -r target/doc/* docs/_build/html/ || true

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/_build/html
          keep_files: false
          force_orphan: true
