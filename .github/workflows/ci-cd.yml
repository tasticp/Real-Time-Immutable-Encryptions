name: "Immutable Encryption CI/CD"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 0" # Weekly security scan

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  OPENCV_DISABLE_PROBES: 1
  LIBCLANG_PATH: /usr/lib/x86_64-linux-gnu
  PKG_CONFIG_PATH: /usr/lib/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig
  PKG_CONFIG_ALLOW_SYSTEM_CFLAGS: 1
  PKG_CONFIG_ALLOW_SYSTEM_LIBS: 1

jobs:
  # Rust Backend Testing
  rust-tests:
    name: Rust Backend Tests
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            libssl-dev \
            libopencv-dev \
            libavformat-dev \
            libavfilter-dev \
            libavdevice-dev \
            libswscale-dev \
            libavcodec-dev \
            libavutil-dev \
            clang \
            libclang-dev \
            cmake \
            build-essential \
            git

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features --features video -- -D warnings

      - name: Run tests
        run: cargo test --all --verbose --features video

      - name: Build release
        run: cargo build --release --verbose --features video

      - name: Upload Rust binaries
        uses: actions/upload-artifact@v4
        with:
          name: rust-binaries
          path: |
            target/release/encryption-node
            target/release/verification-client
            target/release/blockchain-anchor
          retention-days: 7

  # Performance Testing
  performance-test:
    name: Performance Tests
    runs-on: ubuntu-22.04
    needs: rust-tests
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libclang-dev \
            pkg-config \
            libssl-dev \
            libopencv-dev \
            libavformat-dev \
            libavfilter-dev \
            libavdevice-dev \
            libswscale-dev \
            libavcodec-dev \
            libavutil-dev \
            clang \
            libclang-dev

      - name: Run benchmarks
        run: cargo bench --all --features video || echo "No benchmarks defined"

      - name: Run load tests
        run: |
          echo "Installing load testing tools..."
          sudo npm install -g artillery
          echo "Load testing setup complete - add actual test scenarios"

  # Python API Testing
  python-tests:
    name: Python API Tests
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
          cache-dependency-path: "**/requirements.txt"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            libgl1-mesa-glx \
            libglib2.0-0 \
            libsm6 \
            libxext6 \
            libxrender-dev \
            libgomp1

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio black flake8 mypy ruff

      - name: Lint with flake8
        run: |
          flake8 python_api/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 python_api/ --count --max-complexity=10 --max-line-length=120 --statistics

      - name: Check formatting with black
        run: |
          black --check python_api/ || (echo "Black formatting issues found" && exit 1)

      - name: Run mypy type checking
        run: |
          mypy python_api/ --ignore-missing-imports --follow-imports=skip --strict-optional

      - name: Run ruff linting
        run: |
          ruff check python_api/ --config=pyproject.toml

      - name: Run tests with coverage
        run: |
          cd python_api
          python -m pytest --cov=. --cov-report=xml --cov-report=html --cov-fail-under=80 -v

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: matrix.python-version == '3.11' && success()
        with:
          file: python_api/coverage.xml
          flags: unittests
          name: python-coverage

  # Security Scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"
          ignore-unfixed: true

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && github.event.pull_request.head.repo.full_name == github.repository
        with:
          sarif_file: "trivy-results.sarif"

      - name: Run Snyk security scan
        uses: snyk/actions/python-3.11@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: Run Bandit security scan
        run: |
          pip install bandit
          bandit -r python_api/ -f json -o bandit-results.json || true

      - name: Upload Bandit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-results
          path: bandit-results.json
          retention-days: 7

  # Build and Test Docker Images
  docker-test:
    name: Docker Build Test
    runs-on: ubuntu-22.04
    needs: [rust-tests, python-tests]
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build Rust backend image
        run: |
          docker build -f docker/rust-backend.Dockerfile -t immutable-encryption:test-rust .

      - name: Build Python API image
        run: |
          docker build -f docker/python-api.Dockerfile -t immutable-encryption:test-python .

      - name: Build Streamlit image
        run: |
          docker build -f docker/streamlit.Dockerfile -t immutable-encryption:test-streamlit .

      - name: Test Docker containers
        run: |
          # Test Rust container
          docker run --rm -d -p 8080:8080 --name test-rust immutable-encryption:test-rust
          sleep 15
          for i in {1..5}; do
            if curl -f http://localhost:8080/health; then
              echo "Rust health check passed"
              break
            fi
            sleep 5
            echo "Retry $i/5..."
          done
          docker logs test-rust || true
          docker stop test-rust || true

          # Test Python container
          docker run --rm -d -p 8000:8000 --name test-python immutable-encryption:test-python
          sleep 15
          for i in {1..5}; do
            if curl -f http://localhost:8000/health; then
              echo "Python health check passed"
              break
            fi
            sleep 5
            echo "Retry $i/5..."
          done
          docker logs test-python || true
          docker stop test-python || true

      - name: Push Docker images (main branch only)
        if: github.ref == 'refs/heads/main' && success()
        run: |
          docker tag immutable-encryption:test-rust ${{ secrets.DOCKER_HUB_USERNAME }}/immutable-encryption-rust:latest
          docker tag immutable-encryption:test-python ${{ secrets.DOCKER_HUB_USERNAME }}/immutable-encryption-python:latest
          docker tag immutable-encryption:test-streamlit ${{ secrets.DOCKER_HUB_USERNAME }}/immutable-encryption-streamlit:latest
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/immutable-encryption-rust:latest
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/immutable-encryption-python:latest
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/immutable-encryption-streamlit:latest

  # Deploy to Staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-22.04
    needs: [docker-test, performance-test, security-scan]
    if: github.ref == 'refs/heads/develop'
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install deployment dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            curl \
            jq \
            awscli

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy to staging
        run: |
          echo "Deploying to staging environment..."
          # Add actual deployment logic here
          # Example: aws ecs update-service --cluster staging-cluster --service immutable-encryption --force-new-deployment
          echo "Staging deployment completed"

      - name: Verify staging deployment
        run: |
          echo "Verifying staging deployment..."
          # Add health check verification
          # curl -f https://staging.immutable-encryption.com/health || exit 1
          echo "Staging verification completed"

  # Deploy to Production
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-22.04
    needs: [docker-test, performance-test, security-scan]
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install deployment dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            curl \
            jq \
            awscli

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Deploy to production
        run: |
          echo "Deploying to production environment..."
          # Add actual deployment logic here
          # Example: aws ecs update-service --cluster production-cluster --service immutable-encryption --force-new-deployment
          echo "Production deployment completed"

      - name: Verify production deployment
        run: |
          echo "Verifying production deployment..."
          # Add health check verification
          # curl -f https://immutable-encryption.com/health || exit 1
          echo "Production verification completed"

      - name: Notify deployment success
        if: success()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_COLOR: good
          SLACK_TITLE: "Production Deployment Successful"
          SLACK_MESSAGE: "Immutable Encryption has been successfully deployed to production"

      - name: Notify deployment failure
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_COLOR: danger
          SLACK_TITLE: "Production Deployment Failed"
          SLACK_MESSAGE: "Immutable Encryption deployment to production failed. Check logs for details."

  # Documentation
  docs:
    name: Build Documentation
    runs-on: ubuntu-22.04
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install sphinx sphinx-rtd-theme sphinx-autodoc-typehints

      - name: Build API documentation
        run: |
          echo "Building API documentation..."
          mkdir -p docs/_build/html
          # Generate Rust documentation
          cargo doc --no-deps --features video
          cp -r target/doc/* docs/_build/html/ || true
          # Generate Python documentation
          echo "# Immutable Encryption API" > docs/_build/html/index.html
          echo "<h1>Rust API Documentation</h1>" >> docs/_build/html/index.html
          echo "<p><a href='immutable_encryption/index.html'>Rust Library</a></p>" >> docs/_build/html/index.html
          echo "<h1>Python API Documentation</h1>" >> docs/_build/html/index.html
          echo "<p>Python API docs would be generated here</p>" >> docs/_build/html/index.html

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: docs/_build/html
          retention-days: 7

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/_build/html
          keep_files: false
          force_orphan: true
